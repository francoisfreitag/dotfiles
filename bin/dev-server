#!/bin/bash

set -e
set -u

WINDOW_NAME="dev-server"

tmux kill-window -t ${WINDOW_NAME} 2>/dev/null || true
tmux new-window -n ${WINDOW_NAME} -c '#{pane_current_path}'
tmux split-window -t ${WINDOW_NAME} -h -c '#{pane_current_path}'
tmux split-window -t ${WINDOW_NAME} -v -c '#{pane_current_path}'
tmux send-keys -t "${WINDOW_NAME}.{left}" \
    "make -j node_modules venv src/revision.json src/legacy/admin/taskconf.php src/legacy/admin/urlconf.php static &&
     ./manage.py migrateall --no-input --traceback &&
     tmux send-keys -t ${WINDOW_NAME}.{top-right} 'make run-django' &&
     tmux send-keys -t ${WINDOW_NAME}.{bottom-right} 'php -S localhost:8001 -t src/legacy/public' &&
     tmux send-keys -t ${WINDOW_NAME}.{left} 'make run-webpack' &&
     tmux set-window-option -t ${WINDOW_NAME} synchronize-panes &&
     tmux send-keys -t ${WINDOW_NAME}.{left} Enter" Enter
